<div class="nav-btn" id="btn-fav" onclick="toggleSection('fav')">
    <svg class="heart-icon" viewBox="0 0 24 24">
        <path
            d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
    </svg>
    <span>æˆ‘çš„æ”¶è—</span>
    <span class="fav-badge" id="fav-badge">0</span>
</div>
</div>
</div>

<div class="container">
    <!-- About Section -->
    <div class="expandable-section" id="section-about">
        <div class="notice-content">
            <p>ç”±äºä¸­æ—¥ä¸¤å›½æ–°é—»å­˜åœ¨å·¨å¤§çŸ›ç›¾å’Œäº‰è®®ï¼Œå› æ­¤æœ¬ç½‘ç«™ä¸“æ³¨èšåˆæ—¥æœ¬åª’ä½“å‘å¸ƒçš„ä¸­å›½æ–°é—»ï¼Œå°½åŠ›æ¶ˆé™¤ä¿¡æ¯å·®ã€‚æ¯ä¸€ä¸ªå°æ—¶è‡ªåŠ¨æŠ“å–ä¸€æ¬¡æ—¥æœ¬è°·æ­Œæ–°é—»ä¸­åŒ…å«"ä¸­å›½"å…³é”®å­—çš„å®æ—¶æ•°æ®ï¼Œé¦–é¡µå±•ç¤ºè¿‘3å¤©çš„è®°å½•ï¼Œè¶…è¿‡3å¤©çš„å†å²æ–°é—»ä¼šæ”¶å½•è¿›å­˜æ¡£æ°¸ä¹…ä¿å­˜ã€‚ç»æµ‹è¯•ç›®å‰å›½å†…è®¿é—®æ²¡æœ‰é—®é¢˜ã€‚
            </p>
            <p>æœ¬ç½‘ç«™å…¨ç¨‹ç”±Geminiåˆ¶ä½œï¼Œéƒ¨ç½²åœ¨cloudflareä¸Šï¼Œç›®å‰è¯•è¿è¥çŠ¶æ€ï¼Œè¿˜åœ¨æŒç»­æ›´æ–°ä¼˜åŒ–ä¸­ã€‚å¦‚æœä½ å¯¹è¿™äº›æ–°é—»æ„Ÿå…´è¶£ï¼Œè¯·æŠŠæœ¬ç½‘é¡µæ·»åŠ åˆ°æ‰‹æœºä¸»å±å¹•ä¸Šï¼ˆç”¨æ‰‹æœºè‡ªå¸¦æµè§ˆå™¨æŒ‰åˆ†äº«åæ·»åŠ åˆ°ä¸»å±å¹•ä¸Šå³å¯ï¼‰ã€‚
            </p>
            <p style="font-size: 12px; color: #999; margin-top: 10px;">*å› æŠ€æœ¯åŸå› ï¼Œç½‘ç«™å¼€é€šå‰çš„å†å²æ•°æ®æ— æ³•æŠ“å–ï¼Œå°½è¯·è°…è§£ã€‚</p>
        </div>
    </div>

    <!-- Favorites Section -->
    <div class="expandable-section" id="section-fav">
        <div id="fav-list" class="fav-list-container"></div>
    </div>

    <!-- Control Bar -->
    <div class="control-bar">
        <div class="section-title-group">
            <div class="section-title" id="list-title">Latest News</div>
            <button class="back-btn" id="back-btn" onclick="filterByCategory('all')">è¿”å›</button>
        </div>
        <div class="sort-group">
            <button class="sort-btn active" id="btn-hot" onclick="sortNews('hot')">ğŸ”¥ çƒ­åº¦</button>
            <button class="sort-btn" id="btn-time" onclick="sortNews('time')">ğŸ•’ æœ€æ–°</button>
        </div>
    </div>

    <div id="news-list"></div>

    <!-- Archive Section -->
    <div class="archive-section" id="archive-section" style="display:none;">
        <div class="archive-header" onclick="toggleArchive()">
            <span>ğŸ“œ å†å²å­˜æ¡£ (è¶…è¿‡3å¤©)</span>
            <span id="archive-arrow">â–¼</span>
        </div>
        <div class="archive-list" id="archive-list"></div>
    </div>
</div>

<div id="news-modal" onclick="closeModal(event)">
    <div class="modal-content">
        <img src="" class="modal-img" id="m-img">
        <div class="modal-body">
            <div class="modal-title" id="m-title"></div>
            <div class="modal-origin-title" id="m-origin"></div>
            <a href="#" target="_blank" class="modal-btn" id="m-btn">é˜…è¯»åŸæ–‡</a>
        </div>
    </div>
</div>

<script>
    let rawNewsData = [];
    let favorites = JSON.parse(localStorage.getItem('jt_favorites') || '[]');
    let currentSort = 'hot';
    let currentFilter = 'all';

    function init() {
        if (/MicroMessenger/i.test(navigator.userAgent)) document.getElementById('wx-mask').style.display = 'block';
        checkPWA();
        updateFavBadge();
        loadNews();
        document.getElementById('install-close').onclick = () => document.getElementById('install-banner').style.display = 'none';
    }

    function toggleSection(sectionName) {
        const aboutSec = document.getElementById('section-about');
        const favSec = document.getElementById('section-fav');
        const btnAbout = document.getElementById('btn-about');
        const btnFav = document.getElementById('btn-fav');

        if (sectionName === 'about') {
            // Toggle About
            const isOpen = aboutSec.classList.contains('open');
            if (isOpen) {
                aboutSec.classList.remove('open');
                btnAbout.classList.remove('active');
            } else {
                // Close Fav if open
                favSec.classList.remove('open');
                btnFav.classList.remove('active');
                // Open About
                aboutSec.classList.add('open');
                btnAbout.classList.add('active');
            }
        } else if (sectionName === 'fav') {
            // Toggle Fav
            const isOpen = favSec.classList.contains('open');
            if (isOpen) {
                favSec.classList.remove('open');
                btnFav.classList.remove('active');
            } else {
                // Close About if open
                aboutSec.classList.remove('open');
                btnAbout.classList.remove('active');
                // Open Fav
                favSec.classList.add('open');
                btnFav.classList.add('active');
                renderFavorites();
            }
        }
    }

    function toggleArchive() {
        const list = document.getElementById('archive-list');
        const arrow = document.getElementById('archive-arrow');
        const isShown = list.style.display === 'block';
        list.style.display = isShown ? 'none' : 'block';
        arrow.innerText = isShown ? 'â–¼' : 'â–²';
    }

    function checkPWA() {
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
        if (!isStandalone && isIOS) {
            document.getElementById('install-banner').style.display = 'flex';
            document.getElementById('install-text').innerText = "ç‚¹å‡»åº•éƒ¨åˆ†äº«æŒ‰é’®ï¼Œé€‰æ‹©â€œæ·»åŠ åˆ°ä¸»å±å¹•â€ ğŸ“²";
        }
    }

    function loadNews() {
        const container = document.getElementById('news-list');
        container.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">Loading...</p>';

        fetch(`data.json?t=${Date.now()}`)
            .then(res => {
                if (!res.ok) throw new Error("No Data");
                return res.json();
            })
            .then(data => {
                if (Array.isArray(data)) {
                    rawNewsData = data;
                } else if (data.china) {
                    rawNewsData = data.china;
                } else {
                    rawNewsData = [];
                }
                processAndRender();
            })
            .catch(err => {
                container.innerHTML = '<div style="text-align:center;padding:30px;color:#ccc;">æš‚æ— æ–°é—»æ•°æ®</div>';
            });
    }

    function sortNews(type) {
        currentSort = type;
        document.getElementById('btn-hot').className = type === 'hot' ? 'sort-btn active' : 'sort-btn';
        document.getElementById('btn-time').className = type === 'time' ? 'sort-btn active' : 'sort-btn';
        processAndRender();
    }

    function filterByCategory(cat) {
        currentFilter = cat;
        const title = document.getElementById('list-title');
        const backBtn = document.getElementById('back-btn');

        if (cat === 'all') {
            title.innerText = 'Latest News';
            backBtn.style.display = 'none';
        } else {
            title.innerText = `${cat}`;
            backBtn.style.display = 'flex';
        }
        processAndRender();
    }

    function toggleFavorite(e, itemStr) {
        e.stopPropagation();
        const item = JSON.parse(decodeURIComponent(itemStr));
        const index = favorites.findIndex(f => f.link === item.link);

        if (index > -1) {
            favorites.splice(index, 1);
        } else {
            // Add new favorite, mark as unread (isRead = false)
            item.isRead = false;
            favorites.unshift(item);
        }

        localStorage.setItem('jt_favorites', JSON.stringify(favorites));
        updateFavBadge();
        processAndRender(); // Re-render to update heart icon
        if (document.getElementById('section-fav').classList.contains('open')) renderFavorites();
    }

    function updateFavBadge() {
        const b = document.getElementById('fav-badge');
        // Count unread favorites
        const unreadCount = favorites.filter(f => !f.isRead).length;

        if (unreadCount > 0) {
            b.style.display = 'block';
            b.innerText = unreadCount;
        } else {
            b.style.display = 'none';
        }
    }

    function renderFavorites() {
        const container = document.getElementById('fav-list');
        if (favorites.length === 0) {
            container.innerHTML = '<div style="text-align:center;color:#ccc;padding:20px;">æš‚æ— æ”¶è—</div>';
            return;
        }
        let html = '';
        favorites.forEach(item => {
            html += createCardHtml(item, true);
        });
        container.innerHTML = html;
    }

    function processAndRender() {
        const container = document.getElementById('news-list');
        const archiveList = document.getElementById('archive-list');
        const archiveSection = document.getElementById('archive-section');

        if (!rawNewsData || rawNewsData.length === 0) {
            container.innerHTML = '<div style="text-align:center;padding:30px;color:#ccc;">æš‚æ— ç›¸å…³æ–°é—»</div>';
            return;
        }

        // 1. Filter
        let filtered = rawNewsData;
        if (currentFilter !== 'all') {
            filtered = rawNewsData.filter(i => (i.category || 'å…¶ä»–') === currentFilter);
        }

        // 2. Sort
        let sorted = [...filtered];
        if (currentSort === 'time') {
            sorted.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
        } else {
            // Hot (Default RSS order) - assuming rawNewsData is already in RSS order
            // If filtered, we keep relative order
        }

        // 3. Split Recent / Archive
        const now = new Date();
        const threeDaysAgo = new Date();
        threeDaysAgo.setDate(now.getDate() - 3);
        threeDaysAgo.setHours(0, 0, 0, 0);

        const recent = [];
        const archived = [];

        sorted.forEach(item => {
            const itemDate = new Date(item.timestamp * 1000);
            if (itemDate >= threeDaysAgo) {
                recent.push(item);
                let currentSort = 'hot';
                let currentFilter = 'all';

                function init() {
                    if (/MicroMessenger/i.test(navigator.userAgent)) document.getElementById('wx-mask').style.display = 'block';
                    checkPWA();
                    updateFavBadge();
                    loadNews();
                    document.getElementById('install-close').onclick = () => document.getElementById('install-banner').style.display = 'none';
                }

                function toggleSection(sectionName) {
                    const aboutSec = document.getElementById('section-about');
                    const favSec = document.getElementById('section-fav');
                    const btnAbout = document.getElementById('btn-about');
                    const btnFav = document.getElementById('btn-fav');

                    if (sectionName === 'about') {
                        // Toggle About
                        const isOpen = aboutSec.classList.contains('open');
                        if (isOpen) {
                            aboutSec.classList.remove('open');
                            btnAbout.classList.remove('active');
                        } else {
                            // Close Fav if open
                            favSec.classList.remove('open');
                            btnFav.classList.remove('active');
                            // Open About
                            aboutSec.classList.add('open');
                            btnAbout.classList.add('active');
                        }
                    } else if (sectionName === 'fav') {
                        // Toggle Fav
                        const isOpen = favSec.classList.contains('open');
                        if (isOpen) {
                            favSec.classList.remove('open');
                            btnFav.classList.remove('active');
                        } else {
                            // Close About if open
                            aboutSec.classList.remove('open');
                            btnAbout.classList.remove('active');
                            // Open Fav
                            favSec.classList.add('open');
                            btnFav.classList.add('active');
                            renderFavorites();
                        }
                    }
                }

                function toggleArchive() {
                    const list = document.getElementById('archive-list');
                    const arrow = document.getElementById('archive-arrow');
                    const isShown = list.style.display === 'block';
                    list.style.display = isShown ? 'none' : 'block';
                    arrow.innerText = isShown ? 'â–¼' : 'â–²';
                }

                function checkPWA() {
                    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
                    if (!isStandalone && isIOS) {
                        document.getElementById('install-banner').style.display = 'flex';
                        document.getElementById('install-text').innerText = "ç‚¹å‡»åº•éƒ¨åˆ†äº«æŒ‰é’®ï¼Œé€‰æ‹©â€œæ·»åŠ åˆ°ä¸»å±å¹•â€ ğŸ“²";
                    }
                }

                function loadNews() {
                    const container = document.getElementById('news-list');
                    container.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">Loading...</p>';

                    fetch(`data.json?t=${Date.now()}`)
                        .then(res => {
                            if (!res.ok) throw new Error("No Data");
                            return res.json();
                        })
                        .then(data => {
                            if (Array.isArray(data)) {
                                rawNewsData = data;
                            } else if (data.china) {
                                rawNewsData = data.china;
                            } else {
                                rawNewsData = [];
                            }
                            processAndRender();
                        })
                        .catch(err => {
                            container.innerHTML = '<div style="text-align:center;padding:30px;color:#ccc;">æš‚æ— æ–°é—»æ•°æ®</div>';
                        });
                }

                function sortNews(type) {
                    currentSort = type;
                    document.getElementById('btn-hot').className = type === 'hot' ? 'sort-btn active' : 'sort-btn';
                    document.getElementById('btn-time').className = type === 'time' ? 'sort-btn active' : 'sort-btn';
                    processAndRender();
                }

                function filterByCategory(cat) {
                    currentFilter = cat;
                    const title = document.getElementById('list-title');
                    const backBtn = document.getElementById('back-btn');

                    if (cat === 'all') {
                        title.innerText = 'Latest News';
                        backBtn.style.display = 'none';
                    } else {
                        title.innerText = `${cat}`;
                        backBtn.style.display = 'flex';
                    }
                    processAndRender();
                }

                function toggleFavorite(e, itemStr) {
                    e.stopPropagation();
                    const item = JSON.parse(decodeURIComponent(itemStr));
                    const index = favorites.findIndex(f => f.link === item.link);

                    if (index > -1) {
                        favorites.splice(index, 1);
                    } else {
                        // Add new favorite, mark as unread (isRead = false)
                        item.isRead = false;
                        favorites.unshift(item);
                    }

                    localStorage.setItem('jt_favorites', JSON.stringify(favorites));
                    updateFavBadge();
                    processAndRender(); // Re-render to update heart icon
                    if (document.getElementById('section-fav').classList.contains('open')) renderFavorites();
                }

                function updateFavBadge() {
                    const b = document.getElementById('fav-badge');
                    // Count unread favorites
                    const unreadCount = favorites.filter(f => !f.isRead).length;

                    if (unreadCount > 0) {
                        b.style.display = 'block';
                        b.innerText = unreadCount;
                    } else {
                        b.style.display = 'none';
                    }
                }

                function renderFavorites() {
                    const container = document.getElementById('fav-list');
                    if (favorites.length === 0) {
                        container.innerHTML = '<div style="text-align:center;color:#ccc;padding:20px;">æš‚æ— æ”¶è—</div>';
                        return;
                    }
                    let html = '';
                    favorites.forEach(item => {
                        html += createCardHtml(item, true);
                    });
                    container.innerHTML = html;
                }

                function processAndRender() {
                    const container = document.getElementById('news-list');
                    const archiveList = document.getElementById('archive-list');
                    const archiveSection = document.getElementById('archive-section');

                    if (!rawNewsData || rawNewsData.length === 0) {
                        container.innerHTML = '<div style="text-align:center;padding:30px;color:#ccc;">æš‚æ— ç›¸å…³æ–°é—»</div>';
                        return;
                    }

                    // 1. Filter
                    let filtered = rawNewsData;
                    if (currentFilter !== 'all') {
                        filtered = rawNewsData.filter(i => (i.category || 'å…¶ä»–') === currentFilter);
                    }

                    // 2. Sort
                    let sorted = [...filtered];
                    if (currentSort === 'time') {
                        sorted.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                    } else {
                        // Hot (Default RSS order) - assuming rawNewsData is already in RSS order
                        // If filtered, we keep relative order
                    }

                    // 3. Split Recent / Archive
                    const now = new Date();
                    const threeDaysAgo = new Date();
                    threeDaysAgo.setDate(now.getDate() - 3);
                    threeDaysAgo.setHours(0, 0, 0, 0);

                    const recent = [];
                    const archived = [];

                    sorted.forEach(item => {
                        const itemDate = new Date(item.timestamp * 1000);
                        if (itemDate >= threeDaysAgo) {
                            recent.push(item);
                        } else {
                            archived.push(item);
                        }
                    });

                    // 4. Render Recent
                    let html = '';
                    recent.forEach((item) => {
                        html += createCardHtml(item);
                    });
                    container.innerHTML = html || '<div style="text-align:center;padding:20px;color:#ccc;">æš‚æ— æ–°é—»</div>';

                    // 5. Render Archive
                    if (archived.length > 0 && currentFilter === 'all') { // Only show archive in 'all' view to avoid confusion
                        archiveSection.style.display = 'block';
                        let archHtml = '';
                        archived.forEach(item => {
                            archHtml += `
                    <a href="${item.link}" target="_blank" class="archive-item">
                        <span class="archive-date">${item.time_str.split(' ')[0]}</span>
                        <span class="archive-title">${item.title}</span>
                    </a>`;
                        });
                        archiveList.innerHTML = archHtml;
                    } else {
                        archiveSection.style.display = 'none';
                    }
                }

                function createCardHtml(item, isFavView = false) {
                    const imgClass = item.image ? 'card-img show' : 'card-img';
                    const safeItem = encodeURIComponent(JSON.stringify(item));
                    const isFav = favorites.some(f => f.link === item.link);
                    const favIconClass = isFav ? 'card-fav-btn active' : 'card-fav-btn';
                    const category = item.category || 'å…¶ä»–';

                    // Only show category tag if it's NOT 'å…¶ä»–'
                    const catTagHtml = category !== 'å…¶ä»–'
                        ? `<span class="tag tag-cat" onclick="event.stopPropagation(); filterByCategory('${category}')">${category}</span>`
                        : '';

                    const summaryHtml = item.summary ? `<div class="card-summary">${item.summary}</div>` : '';

                    return `
            <a href="${item.link}" target="_blank" class="card" onclick="handleCardClick(event, '${safeItem}', ${isFavView})">
                <img src="${item.image || ''}" class="${imgClass}">
                <div class="card-body">
                    <div class="card-meta">
                        <span class="tag tag-time">${item.time_str}</span>
                        ${catTagHtml}
                        <span class="card-origin">${item.origin.split(' - ')[0]}</span>
                    </div>
                    <div class="card-title">${item.title}</div>
                    ${summaryHtml}
                    <div class="${favIconClass}" onclick="toggleFavorite(event, '${safeItem}')">
                        <svg viewBox="0 0 24 24">
                            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                        </svg>
                    </div>
                </div>
            </a>`;
                }

                function handleCardClick(e, itemStr, isFavView) {
                    // If clicking fav icon or tag, don't do anything (handled by their own listeners)
                    // But since we wrapped in <a>, we might need to prevent default if we wanted to track clicks or something.
                    // For now, just let the <a> tag handle the navigation.

                    // If opening from favorites, mark as read
                    if (isFavView) {
                        const item = JSON.parse(decodeURIComponent(itemStr));
                        const index = favorites.findIndex(f => f.link === item.link);
                        if (index > -1 && !favorites[index].isRead) {
                            favorites[index].isRead = true;
                            localStorage.setItem('jt_favorites', JSON.stringify(favorites));
                            updateFavBadge();
                        }
                    }
                }

                init();
</script>
</body>

</html>